<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW MAZE: BOMBER-VIEW</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        #ui { position: absolute; top: 10px; left: 10px; color: #0f0; pointer-events: none; z-index: 10; font-weight: bold; }
        
        /* Mobile D-Pad Controls */
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 20; }
        .dpad { display: grid; grid-template-columns: repeat(3, 65px); grid-template-rows: repeat(2, 65px); gap: 5px; }
        .btn { width: 65px; height: 65px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; }
        .btn:active { background: rgba(255,255,255,0.3); border-color: #fff; }
        #fire-btn { width: 80px; height: 135px; background: rgba(255, 0, 0, 0.2); border-color: #f00; color: #f00; }

        /* Overlays */
        #static { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://media.giphy.com/media/oEI9uWUicGLeE/giphy.gif'); opacity: 0; pointer-events: none; z-index: 5; }
        #game-over { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: red; }
    </style>
</head>
<body>

<div id="ui">
    <div>OBJ: FIND KEY & EXIT</div>
    <div id="inv">KEYS: 0/1</div>
</div>

<div id="static"></div>

<div class="controls">
    <div class="dpad">
        <div class="btn" id="up" style="grid-column: 2;">↑</div>
        <div class="btn" id="left" style="grid-row: 2;">←</div>
        <div class="btn" id="down" style="grid-row: 2;">↓</div>
        <div class="btn" id="right" style="grid-row: 2;">→</div>
    </div>
    <div class="btn" id="fire-btn">FLASH</div>
</div>

<div id="game-over">
    <h1 id="msg">YOU WERE CAUGHT</h1>
    <button onclick="location.reload()" style="padding: 15px 30px; background: red; color: white; border: none; font-weight: bold;">REPLAY</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let scene, camera, renderer, player, villain, key, exit;
    let walls = [];
    let moves = { up: false, down: false, left: false, right: false };
    let hasKey = false, isDead = false;
    const speed = 0.12;

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);

        // Top-down Orthographic-style Perspective
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 18, 5); 
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambient = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambient);
        const pLight = new THREE.PointLight(0xffffff, 1, 15);
        scene.add(pLight);

        // Player (Blue Cube)
        player = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({color: 0x00aaff}));
        player.position.set(-7, 0.4, -7);
        scene.add(player);

        // Villain (Tall Black Cube)
        villain = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), new THREE.MeshBasicMaterial({color: 0x000000}));
        villain.position.set(7, 0.9, 7);
        scene.add(villain);

        // Generate Grid Maze
        const wallGeo = new THREE.BoxGeometry(1.8, 2, 1.8);
        const wallMat = new THREE.MeshStandardMaterial({color: 0x222222});

        for(let x = -5; x <= 5; x++) {
            for(let z = -5; z <= 5; z++) {
                if(Math.random() > 0.7 && Math.abs(x) > 1 && Math.abs(z) > 1) {
                    const wall = new THREE.Mesh(wallGeo, wallMat);
                    wall.position.set(x * 2, 1, z * 2);
                    scene.add(wall);
                    walls.push(wall);
                }
            }
        }

        // Key
        key = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color: 0xffff00}));
        key.position.set(8, 0.5, 8);
        scene.add(key);

        // Exit
        exit = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), new THREE.MeshBasicMaterial({color: 0x00ff00, side: THREE.DoubleSide}));
        exit.rotation.x = Math.PI / 2;
        exit.position.set(-8, 0.01, -8);
        scene.add(exit);

        setupInputs();
    }

    function setupInputs() {
        const bind = (id, dir) => {
            const el = document.getElementById(id);
            el.ontouchstart = (e) => { e.preventDefault(); moves[dir] = true; };
            el.ontouchend = (e) => { e.preventDefault(); moves[dir] = false; };
        };
        bind('up', 'up'); bind('down', 'down'); bind('left', 'left'); bind('right', 'right');
        
        document.getElementById('fire-btn').ontouchstart = (e) => {
            e.preventDefault();
            if(player.position.distanceTo(villain.position) < 5) {
                villain.position.set(0, 0.9, 0); // Reset villain to center
            }
        };
    }

    function animate() {
        if(isDead) return;
        requestAnimationFrame(animate);

        // Movement with Collision
        let next = player.position.clone();
        if(moves.up) next.z -= speed;
        if(moves.down) next.z += speed;
        if(moves.left) next.x -= speed;
        if(moves.right) next.x += speed;

        let canMove = true;
        walls.forEach(w => { if(next.distanceTo(w.position) < 1.4) canMove = false; });
        if(canMove) player.position.copy(next);

        // Camera follow (Smoothed)
        camera.position.x += (player.position.x - camera.position.x) * 0.1;
        camera.position.z += (player.position.z + 5 - camera.position.z) * 0.1;

        // Villain AI (Pathfinding toward player)
        const vDir = new THREE.Vector3().subVectors(player.position, villain.position).normalize();
        villain.position.addScaledVector(vDir, 0.04);

        // Distance FX (Static)
        const d = player.position.distanceTo(villain.position);
        document.getElementById('static').style.opacity = Math.max(0, 1 - (d / 7));

        // Game Logic
        if(d < 0.8) { isDead = true; document.getElementById('game-over').style.display = 'flex'; }
        
        if(!hasKey && player.position.distanceTo(key.position) < 1) {
            hasKey = true; key.visible = false;
            document.getElementById('inv').innerText = "KEYS: 1/1";
            document.getElementById('inv').style.color = "yellow";
        }

        if(hasKey && player.position.distanceTo(exit.position) < 1.2) {
            document.getElementById('msg').innerText = "YOU ESCAPED!";
            document.getElementById('msg').style.color = "#0f0";
            isDead = true;
            document.getElementById('game-over').style.display = 'flex';
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
