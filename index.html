<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHADOW ESCAPE: TACTICAL</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #111; touch-action: none; }
        #ui { position: absolute; top: 15px; left: 15px; color: white; pointer-events: none; z-index: 5; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 20; }
        .grid-ctrl { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 10px; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border: 2px solid #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .btn:active { background: rgba(255,255,255,0.5); }
        #static-overlay { position: fixed; top:0; left:0; width:100vw; height:100vh; background: url('https://media.giphy.com/media/oEI9uWUicGLeE/giphy.gif'); opacity: 0; pointer-events: none; z-index: 10; }
        #jumpscare { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; display: none; z-index: 100; flex-direction: column; align-items: center; justify-content: center; color: red; }
    </style>
</head>
<body>

<div id="static-overlay"></div>
<div id="ui">
    <div id="status">FIND THE KEY</div>
    <div id="inventory">KEYS: 0/1</div>
</div>

<div class="controls">
    <div class="grid-ctrl">
        <div style="grid-column: 2" class="btn" id="up">↑</div>
        <div class="btn" id="left" style="grid-row: 2">←</div>
        <div class="btn" id="down" style="grid-row: 2">↓</div>
        <div class="btn" id="right" style="grid-row: 2">→</div>
    </div>
    <div class="btn" id="fire" style="background: rgba(0,255,255,0.3); width: 80px; height: 130px;">FLASH</div>
</div>

<div id="jumpscare"><h1>CAUGHT</h1><button onclick="location.reload()">RETRY</button></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let scene, camera, renderer, player, villain, key, door;
    let walls = [], hasKey = false, isGameOver = false;
    let move = { up: false, down: false, left: false, right: false };
    const mazeSize = 11, wallSize = 2;

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        // Top-down Camera
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 8); // High up looking down
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0x404040, 2)); // Brighter world

        // Player Model (Blue Sphere)
        player = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshStandardMaterial({color: 0x0088ff}));
        player.position.set(-8, 0.5, -8);
        scene.add(player);

        // Maze generation logic (Simplified for clarity)
        const wallGeo = new THREE.BoxGeometry(wallSize, 2, wallSize);
        const wallMat = new THREE.MeshStandardMaterial({color: 0x444444});
        for(let i=0; i<40; i++) { // Random scattered blocks
            let w = new THREE.Mesh(wallGeo, wallMat);
            w.position.set(Math.floor(Math.random()*10 - 5)*2, 1, Math.floor(Math.random()*10 - 5)*2);
            if(w.position.distanceTo(player.position) > 3) {
                scene.add(w);
                walls.push(w);
            }
        }

        // Key and Door
        key = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshBasicMaterial({color: 0xffff00}));
        key.position.set(8, 0.5, 8);
        scene.add(key);

        door = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.2, 1.5), new THREE.MeshBasicMaterial({color: 0x00ff00, transparent: true, opacity: 0.5}));
        door.position.set(8, 0.1, -8);
        scene.add(door);

        // Villain
        villain = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshBasicMaterial({color: 0x000000}));
        villain.position.set(0, 1, 0);
        scene.add(villain);

        setupControls();
    }

    function setupControls() {
        const set = (id, dir, val) => {
            document.getElementById(id).ontouchstart = (e) => { e.preventDefault(); move[dir] = val; };
            document.getElementById(id).ontouchend = (e) => { e.preventDefault(); move[dir] = !val; };
        };
        set('up', 'up', true); set('down', 'down', true);
        set('left', 'left', true); set('right', 'right', true);
        document.getElementById('fire').ontouchstart = () => {
            if (player.position.distanceTo(villain.position) < 5) {
                villain.position.set((Math.random()-0.5)*15, 1, (Math.random()-0.5)*15);
            }
        };
    }

    function animate() {
        if(isGameOver) return;
        requestAnimationFrame(animate);

        let nextPos = player.position.clone();
        if(move.up) nextPos.z -= 0.15;
        if(move.down) nextPos.z += 0.15;
        if(move.left) nextPos.x -= 0.15;
        if(move.right) nextPos.x += 0.15;

        // Collision
        let hit = false;
        walls.forEach(w => { if(nextPos.distanceTo(w.position) < 1.3) hit = true; });
        if(!hit) player.position.copy(nextPos);

        // Camera follow
        camera.position.x = player.position.x;
        camera.position.z = player.position.z + 8;

        // Villain AI
        const vDir = new THREE.Vector3().subVectors(player.position, villain.position).normalize();
        villain.position.addScaledVector(vDir, 0.05);

        // Logic
        const dist = player.position.distanceTo(villain.position);
        document.getElementById('static-overlay').style.opacity = Math.max(0, 1 - (dist/8));
        
        if(dist < 0.8) { isGameOver = true; document.getElementById('jumpscare').style.display = 'flex'; }
        if(!hasKey && player.position.distanceTo(key.position) < 1) { 
            hasKey = true; key.visible = false; 
            document.getElementById('inventory').innerText = "KEYS: 1/1";
        }
        if(hasKey && player.position.distanceTo(door.position) < 1) { alert("WIN!"); location.reload(); }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
