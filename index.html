<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bomber Hero Fixed</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: #111; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #ui { width: 100%; max-width: 400px; padding: 10px; display: flex; justify-content: space-between; background: #333; border-bottom: 2px solid #555; font-weight: bold; }
        canvas { background: #2ecc71; display: block; border: 4px solid #444; margin: 5px 0; touch-action: none; image-rendering: pixelated; }
        .controls { display: grid; grid-template-columns: repeat(3, 85px); grid-gap: 12px; padding: 10px; }
        .btn { width: 85px; height: 85px; background: #34495e; border-radius: 15px; display: flex; align-items: center; justify-content: center; user-select: none; border-bottom: 6px solid #1a252f; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn:active { border-bottom: 0; transform: translateY(4px); background: #2c3e50; }
        #bomb-btn { background: #e74c3c; border-bottom-color: #c0392b; }
        #overlay { position: fixed; inset: 0; background: #111; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .card { background: #2c3e50; padding: 20px; margin: 10px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; border: 2px solid #555; cursor: pointer; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="margin-bottom:20px; color:#f1c40f;">BOMBER HERO</h1>
    <div class="card" onclick="forceStart('Knight', 5, 2)">
        <b>CLASSIC BOMBER</b>
        <small>HP: 5 | POWER: KICK</small>
    </div>
    <div class="card" onclick="forceStart('Ninja', 2, 3)">
        <b>STEALTH BOMBER</b>
        <small>HP: 2 | POWER: PHASE</small>
    </div>
</div>

<div id="ui">
    <div id="st">STAGE: 1</div>
    <div id="hp" style="color:#ff7675">HP: -</div>
    <div id="en">ENEMIES: -</div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <div></div><div class="btn" onclick="move(0,-1)">UP</div><div></div>
    <div class="btn" onclick="move(-1,0)">LEFT</div><div class="btn" id="bomb-btn" onclick="handleBomb()">BOMB</div><div class="btn" onclick="move(1,0)">RIGHT</div>
    <div></div><div class="btn" onclick="move(0,1)">DOWN</div><div></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE = 32, ROWS = 11, COLS = 11;
    canvas.width = COLS * TILE;
    canvas.height = ROWS * TILE;

    let G = [], B = [], E = [], X = [], P_UPS = [];
    let P = { x: 1, y: 1, hp: 0, range: 2, type: '', inv: 0, maxBombs: 1 };
    let stage = 1, active = false, frame = 0;

    function forceStart(type, hp, range) {
        P.type = type; P.hp = hp; P.range = range; P.maxBombs = 1;
        P.x = 1; P.y = 1; P.inv = 0;
        document.getElementById('overlay').style.display = 'none';
        buildLevel();
        active = true;
    }

    function buildLevel() {
        G = []; B = []; E = []; X = []; P_UPS = [];
        for (let r = 0; r < ROWS; r++) {
            G[r] = [];
            for (let c = 0; c < COLS; c++) {
                if (r === 0 || r === ROWS - 1 || c === 0 || c === COLS - 1 || (r % 2 === 0 && c % 2 === 0)) G[r][c] = 1;
                else G[r][c] = (Math.random() < 0.35 && !(r < 3 && c < 3)) ? 2 : 0;
            }
        }
        
        let bricks = [];
        for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(G[r][c]===2) bricks.push({r,c});
        if(bricks.length) G[bricks[0].r][bricks[0].c] = 4; // Door

        for(let i=0; i<stage+1; i++) {
            let rx, ry; 
            do { rx=Math.floor(Math.random()*COLS); ry=Math.floor(Math.random()*ROWS); }
            while(G[ry][rx]!==0 || (rx<4 && ry<4));
            E.push({x:rx, y:ry, dx:1, dy:0, t:0});
        }
    }

    function move(dx, dy) {
        if(!active) return;
        let nx = P.x + dx, ny = P.y + dy;
        
        let bomb = B.find(b => b.x === nx && b.y === ny);
        if(bomb && P.type === 'Knight') { slideBomb(bomb, dx, dy); return; }
        else if (bomb) return;

        if(G[ny][nx] === 1) return;
        if((G[ny][nx] === 2 || G[ny][nx] === 4) && P.type !== 'Ninja') return;
        
        P.x = nx; P.y = ny;
        if(G[ny][nx] === 3 && E.length === 0) { stage++; buildLevel(); }

        P_UPS = P_UPS.filter(p => {
            if(p.x === P.x && p.y === P.y) {
                if(p.type === 'range') P.range++;
                if(p.type === 'hp') P.hp++;
                if(p.type === 'count') P.maxBombs++;
                return false;
            }
            return true;
        });
    }

    function slideBomb(b, dx, dy) {
        let si = setInterval(() => {
            let nx = b.x + dx, ny = b.y + dy;
            if(G[ny][nx] === 0 && !B.find(ob => ob.x === nx && ob.y === ny)) {
                b.x = nx; b.y = ny;
            } else clearInterval(si);
        }, 80);
    }

    function handleBomb() {
        if(!active || B.length >= P.maxBombs) return;
        if(!B.find(b => b.x === P.x && b.y === P.y)) B.push({x: P.x, y: P.y, t: 100});
    }

    function triggerExplosion(bx, by) {
        let ds = [[0,0],[0,1],[0,-1],[1,0],[-1,0]];
        ds.forEach(d => {
            for(let i=0; i<=P.range; i++) {
                let ex = bx + d[0]*i, ey = by + d[1]*i;
                if(G[ey][ex] === 1) break;
                X.push({x:ex, y:ey, l:15});
                if(G[ey][ex] === 2 || G[ey][ex] === 4) {
                    if(Math.random() < 0.25) {
                        let r = Math.random();
                        let type = r < 0.33 ? 'range' : (r < 0.66 ? 'hp' : 'count');
                        P_UPS.push({x: ex, y: ey, type: type});
                    }
                    G[ey][ex] = (G[ey][ex] === 4) ? 3 : 0;
                    break;
                }
                E = E.filter(e => e.x !== ex || e.y !== ey);
                if(P.x === ex && P.y === ey) hit();
            }
        });
    }

    function hit() {
        if(P.inv > 0) return;
        P.hp--; P.inv = 60;
        if(P.hp <= 0) location.reload();
    }

    function drawSprite(x, y, type) {
        if(type === 'player') {
            ctx.fillStyle = "#fff"; ctx.fillRect(x+6, y+4, 20, 22); 
            ctx.fillStyle = P.type === 'Knight' ? "#3498db" : "#2ecc71"; ctx.fillRect(x+4, y+18, 6, 10); ctx.fillRect(x+22, y+18, 6, 10);
            ctx.fillStyle = "#000"; ctx.fillRect(x+10, y+10, 3, 6); ctx.fillRect(x+19, y+10, 3, 6);
        } else {
            ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(x+16, y+16, 12, 0, 7); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.fillRect(x+10, y+10, 4, 4); ctx.fillRect(x+18, y+10, 4, 4);
        }
    }

    function draw() {
        frame++;
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(0,0,canvas.width,canvas.height);
        if(!active) { requestAnimationFrame(draw); return; }

        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                let x=c*TILE, y=r*TILE;
                if(G[r][c] === 1) { ctx.fillStyle='#7f8c8d'; ctx.fillRect(x,y,TILE,TILE); }
                else if(G[r][c] === 2 || G[r][c] === 4) { ctx.fillStyle='#d35400'; ctx.fillRect(x+2,y+2,TILE-4,TILE-4); }
                else if(G[r][c] === 3) { ctx.fillStyle='#27ae60'; ctx.fillRect(x+4,y+4,TILE-8,TILE-8); }
            }
        }

        P_UPS.forEach(p => {
            ctx.fillStyle = p.type === 'range' ? '#f1c40f' : (p.type === 'hp' ? '#e74c3c' : '#3498db');
            ctx.beginPath(); ctx.arc(p.x*TILE+16, p.y*TILE+16, 8, 0, 7); ctx.fill();
        });

        B.forEach(b => { ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(b.x*TILE+16, b.y*TILE+16, 13, 0, 7); ctx.fill(); });
        X.forEach(x => { ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.fillRect(x.x*TILE, x.y*TILE, TILE, TILE); });
        
        E.forEach(e => drawSprite(e.x*TILE, e.y*TILE, 'enemy'));
        if(P.inv % 6 < 3) drawSprite(P.x*TILE, P.y*TILE, 'player');

        B.forEach((b,i) => { b.t--; if(b.t<=0) { triggerExplosion(b.x, b.y); B.splice(i,1); } });
        X.forEach((x,i) => { x.l--; if(x.l<=0) X.splice(i,1); });
        if(P.inv > 0) P.inv--;
        
        E.forEach(e => {
            e.t++; if(e.t > 45) {
                let nx=e.x+e.dx, ny=e.y+e.dy;
                // ENEMY BOMB COLLISION CHECK
                let bombAhead = B.find(b => b.x === nx && b.y === ny);
                if(G[ny][nx]===0 && !bombAhead) { e.x=nx; e.y=ny; }
                else { e.dx = Math.random()>0.5?1:-1; e.dy = e.dx===0?(Math.random()>0.5?1:-1):0; }
                e.t=0;
            }
            if(e.x===P.x && e.y===P.y) hit();
        });

        document.getElementById('hp').innerText = "HP: " + P.hp;
        document.getElementById('st').innerText = "STAGE: " + stage;
        document.getElementById('en').innerText = "ENEMIES: " + E.length;
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
