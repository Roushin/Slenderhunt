<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SlenderHunt: Deca-Logue</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #eee; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        
        #ui-bar { height: 35px; width: 100%; display: flex; justify-content: space-around; align-items: center; background: #111; font-size: 11px; color: #f1c40f; flex-shrink: 0; border-bottom: 1px solid #333; }
        #game-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; min-height: 0; background: #000; }
        canvas { background: #2d5a27; display: block; border: 4px solid #444; max-height: 100%; max-width: 100%; object-fit: contain; image-rendering: pixelated; }
        
        #control-panel { padding: 10px 0 45px 0; background: #000; width: 100%; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; border-top: 1px solid #222; }
        .dpad { display: grid; grid-template-columns: repeat(3, 75px); grid-template-rows: repeat(3, 62px); grid-gap: 12px; }
        .btn { background: #34495e; border-radius: 15px; display: flex; align-items: center; justify-content: center; user-select: none; border-bottom: 5px solid #1a252f; cursor: pointer; font-weight: bold; color: white; font-size: 15px; }
        .btn:active { border-bottom: 0; transform: translateY(4px); background: #2c3e50; }
        #bomb-btn { background: #e74c3c; border-bottom-color: #c0392b; }

        .overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 360px; }
        .card { background: #1a1a1a; padding: 12px; border-radius: 10px; border: 1px solid #444; cursor: pointer; }
        .card b { font-size: 14px; color: #f1c40f; display: block; margin-bottom: 4px; }
        .hidden { display: none !important; }
        
        .story-text { color: #f1c40f; font-style: italic; margin-bottom: 20px; line-height: 1.4; font-size: 14px; max-width: 300px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; width: 280px; margin-bottom: 8px; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #111; cursor: pointer; }
    </style>
</head>
<body>

<div id="intro-screen" class="overlay">
    <h1 style="color:#e74c3c; margin-bottom:10px;">SLENDERHUNT</h1>
    <p class="story-text">Year 204X. The "Slender-Virus" has turned the suburbs into a shifting labyrinth. You are the last operative sent to detonate the core.</p>
    <div class="card-grid">
        <div class="card" onclick="setupGame('Soldier', 5, 2, true, false, false, '#3498db')"><b>SOLDIER</b>HP: 5 | RNG: 2</div>
        <div class="card" onclick="setupGame('Ninja', 3, 3, false, true, true, '#2ecc71')"><b>NINJA</b>HP: 3 | RNG: 3</div>
        <div class="card" onclick="setupGame('Tank', 10, 5, false, false, true, '#e67e22')"><b>HEAVY</b>HP: 10 | RNG: 5</div>
        <div class="card" onclick="setupGame('Ghost', 2, 4, false, true, false, '#9b59b6')"><b>PHANTOM</b>HP: 2 | RNG: 4</div>
    </div>
</div>

<div id="shop-screen" class="overlay hidden">
    <h2 id="story-title" style="color:#e74c3c; margin-bottom:10px;">SECTOR CLEAR</h2>
    <p id="lore-body" class="story-text"></p>
    <p style="margin-bottom: 15px; font-size: 12px; color: #aaa;">Gold: $<span id="shop-gold">0</span></p>
    <div class="shop-item" onclick="buy('hp')"><span>Stim-Pack (+1 HP)</span><span>$100</span></div>
    <div class="shop-item" onclick="buy('range')"><span>Blast Comp (+1 RNG)</span><span>$75</span></div>
    <div class="card" onclick="nextStage()" style="background:#27ae60; color:white; width: 280px;"><b>VENTURE DEEPER</b></div>
</div>

<div id="ui-bar">
    <div>DEPT: <span id="stage-txt">1</span>/10</div>
    <div>HP: <span id="hp-txt">0</span></div>
    <div>GOLD: $<span id="gold-txt">0</span></div>
</div>

<div id="game-area"><canvas id="gameCanvas"></canvas></div>

<div id="control-panel">
    <div class="dpad">
        <div></div><div class="btn" onclick="handleMove(0,-1)">UP</div><div></div>
        <div class="btn" onclick="handleMove(-1,0)">LEFT</div><div class="btn" id="bomb-btn" onclick="handleBombAction()">BOMB</div><div class="btn" onclick="handleMove(1,0)">RIGHT</div>
        <div></div><div class="btn" onclick="handleMove(0,1)">DOWN</div><div></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE = 40, ROWS = 11, COLS = 11;
    canvas.width = COLS * TILE; canvas.height = ROWS * TILE;

    let grid = [], bombs = [], enemies = [], explosions = [], gold = 0;
    let player = { x: 1, y: 1, hp: 0, range: 2, invuln: 0, color: '#fff' };
    let stage = 1, active = false, frame = 0, audioCtx = null;

    const LORE = [
        "", // Stage 1
        "The static in your headset grows louder. They are watching from the shadows.",
        "The suburban walls are changing. This isn't architecture; it's a trap.",
        "You found a survivor's diary. 'Don't look at it,' it says. Too late.",
        "BOSS INBOUND: The Stalker of the First Gate approaches.",
        "Midpoint reached. The grass turns to grey ash. You are entering the Nest.",
        "The Sprinters here are hungry. They smell the gunpowder on your boots.",
        "The Phantoms phase through reality. Your bombs are the only thing that's real.",
        "The air is thin. The Core is just a few sectors away.",
        "FINAL BOSS: The Void Singularity. End the nightmare, Operative."
    ];

    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function sfx(freq, type, dur, vol=0.05) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function setupGame(name, hp, range, kick, phase, remote, color) {
        initAudio();
        Object.assign(player, { name, hp, range, canKick: kick, canPhase: phase, remote: remote, color, x:1, y:1 });
        document.getElementById('intro-screen').classList.add('hidden');
        buildLevel(); active = true;
    }

    function buildLevel() {
        grid = []; bombs = []; enemies = []; explosions = [];
        const isBoss = (stage === 5 || stage === 10);
        for (let r = 0; r < ROWS; r++) {
            grid[r] = [];
            for (let c = 0; c < COLS; c++) {
                if (r === 0 || r === ROWS - 1 || c === 0 || c === COLS - 1 || (r % 2 === 0 && c % 2 === 0)) grid[r][c] = 1;
                else grid[r][c] = (Math.random() < 0.3 && !(r < 3 && c < 3)) ? 2 : 0;
            }
        }
        if (isBoss) {
            enemies.push({ x: 9, y: 9, dx: -1, dy: 0, t: 0, speed: (stage === 10 ? 10 : 15), hp: (stage === 10 ? 50 : 20), isBoss: true, trait: 'boss' });
        } else {
            let bricks = [];
            for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(grid[r][c]===2) bricks.push({r,c});
            if(bricks.length) grid[bricks[0].r][bricks[0].c] = 4;
            let count = stage + 1;
            for(let i=0; i < count; i++) {
                let rx, ry; do { rx = Math.floor(Math.random() * COLS); ry = Math.floor(Math.random() * ROWS); } while(grid[ry][rx] !== 0 || (rx < 4 && ry < 4));
                let trait = (stage > 6 && Math.random() > 0.6) ? 'ghost' : ((stage > 3 && Math.random() > 0.7) ? 'sprinter' : 'grunt');
                enemies.push({ x: rx, y: ry, dx: 1, dy: 0, t: 0, speed: (trait==='sprinter'?20:40), hp: 1, trait: trait });
            }
        }
    }

    function buy(item) {
        if (item === 'hp' && gold >= 100) { gold -= 100; player.hp++; sfx(800, 'sine', 0.2); }
        if (item === 'range' && gold >= 75) { gold -= 75; player.range++; sfx(800, 'sine', 0.2); }
        updateUI();
    }

    function handleMove(dx, dy) {
        if(!active) return;
        let nx = player.x + dx, ny = player.y + dy;
        let bAt = bombs.find(b => b.x === nx && b.y === ny);
        if(bAt && player.canKick) {
            let si = setInterval(() => {
                let bx = bAt.x + dx, by = bAt.y + dy;
                if(grid[by] && grid[by][bx] === 0 && !bombs.find(ob => ob.x === bx && ob.y === by)) { bAt.x = bx; bAt.y = by; }
                else clearInterval(si);
            }, 80); return;
        } 
        if(!grid[ny] || grid[ny][nx] === 1 || bAt) return;
        if((grid[ny][nx] === 2 || grid[ny][nx] === 4) && !player.canPhase) return;
        player.x = nx; player.y = ny;
        if(grid[ny][nx] === 3 && enemies.length === 0) {
            if(stage === 10) { alert("THE NIGHTMARE ENDS. YOU ESCAPED."); location.reload(); return; }
            active = false; 
            document.getElementById('lore-body').innerText = LORE[stage] || "The deeper you go, the less human you feel.";
            document.getElementById('shop-screen').classList.remove('hidden'); 
            updateUI();
        }
    }

    function handleBombAction() {
        if(!active) return;
        if(player.remote && bombs.length > 0) {
            while(bombs.length > 0) { let b = bombs.shift(); explode(b.x, b.y); }
        } else if(bombs.length < 3) {
            if(!bombs.find(b => b.x === player.x && b.y === player.y)) {
                bombs.push({ x: player.x, y: player.y, timer: player.remote ? 9999 : 100 });
                sfx(100, 'square', 0.1);
            }
        }
    }

    function explode(bx, by) {
        sfx(60, 'sawtooth', 0.5, 0.2);
        [[0,0],[0,1],[0,-1],[1,0],[-1,0]].forEach(d => {
            for(let i=0; i <= player.range; i++) {
                let ex = bx + d[0] * i, ey = by + d[1] * i;
                if(!grid[ey] || grid[ey][ex] === 1) break;
                explosions.push({ x: ex, y: ey, life: 15 });
                if(grid[ey][ex] === 2 || grid[ey][ex] === 4) { if(Math.random() > 0.6) gold += 15; grid[ey][ex] = (grid[ey][ex] === 4) ? 3 : 0; break; }
                enemies.forEach((e, idx) => {
                    if (e.x === ex && e.y === ey) { e.hp--; if (e.hp <= 0) { if (e.isBoss) grid[e.y][e.x] = 3; enemies.splice(idx, 1); gold += 50; } }
                });
                if(player.x === ex && player.y === ey) { if(player.invuln === 0) { player.hp--; player.invuln = 60; sfx(40, 'sine', 0.8); } }
            }
        });
        updateUI();
    }

    function updateUI() {
        document.getElementById('hp-txt').innerText = player.hp;
        document.getElementById('gold-txt').innerText = gold;
        document.getElementById('shop-gold').innerText = gold;
        document.getElementById('stage-txt').innerText = stage;
    }

    function nextStage() { stage++; document.getElementById('shop-screen').classList.add('hidden'); buildLevel(); active = true; }

    function drawHuman(x, y, color, frame, invuln, isEnemy, isBoss, hp, trait) {
        if (invuln % 6 < 3 && invuln > 0) return;
        const cx = x * TILE + TILE/2, cy = y * TILE + TILE/2;
        const walk = Math.sin(frame * 0.2) * 3;
        const sm = isBoss ? 1.5 : 1;
        
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(cx - (6*sm), cy + (8*sm) + walk, 5*sm, 6*sm);
        ctx.fillRect(cx + (1*sm), cy + (8*sm) - walk, 5*sm, 6*sm);
        
        let c = isEnemy ? (trait==='sprinter'?'#e74c3c':(trait==='ghost'?'#8e44ad':'#333')) : color;
        if(isBoss) c = "#000";
        ctx.fillStyle = c; ctx.fillRect(cx - (8*sm), cy - (4*sm), 16*sm, 14*sm);
        ctx.fillStyle = "#FFDBAC"; ctx.fillRect(cx - (6*sm), cy - (14*sm), 12*sm, 11*sm);
        ctx.fillStyle = isEnemy ? "#c0392b" : "#1a1a1a"; ctx.fillRect(cx - (7*sm), cy - (15*sm), 14*sm, 6*sm);
        
        if(isBoss) { 
            ctx.fillStyle = "#333"; ctx.fillRect(x*TILE, y*TILE-10, TILE, 4); 
            ctx.fillStyle = "#f00"; ctx.fillRect(x*TILE, y*TILE-10, (hp/(stage===10?50:20))*TILE, 4); 
        }
    }

    function loop() {
        ctx.fillStyle = (stage > 5) ? '#1a1a1a' : '#2d5a27'; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if(active) {
            for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) {
                let x = c*TILE, y = r*TILE;
                if(grid[r][c] === 1) { ctx.fillStyle='#333'; ctx.fillRect(x,y,TILE,TILE); }
                else if(grid[r][c] === 2 || grid[r][c] === 4) { ctx.fillStyle=(stage > 5)?'#444':'#8a3a24'; ctx.fillRect(x+1, y+1, TILE-2, TILE-2); }
                else if(grid[r][c] === 3) { ctx.fillStyle='#000'; ctx.fillRect(x,y,TILE,TILE); ctx.strokeStyle="#0f0"; ctx.strokeRect(x+4,y+4,TILE-8,TILE-8); }
            }
            bombs.forEach((b, i) => {
                ctx.fillStyle = player.remote ? "#9b59b6" : "#111";
                ctx.beginPath(); ctx.arc(b.x*TILE+20, b.y*TILE+20, 12, 0, 7); ctx.fill();
                if(!player.remote) { b.timer--; if(b.timer <= 0) { explode(b.x, b.y); bombs.splice(i, 1); } }
            });
            ctx.fillStyle = 'rgba(255,255,255,0.7)'; explosions.forEach((ex, i) => { ctx.fillRect(ex.x*TILE, ex.y*TILE, TILE, TILE); ex.life--; if(ex.life <= 0) explosions.splice(i, 1); });
            enemies.forEach(e => {
                drawHuman(e.x, e.y, "#e74c3c", frame, 0, true, e.isBoss, e.hp, e.trait);
                e.t++; if(e.t > e.speed) {
                    let nx = e.x + e.dx, ny = e.y + e.dy;
                    let canGo = (grid[ny] && grid[ny][nx] === 0);
                    if(e.trait === 'ghost' && grid[ny] && (grid[ny][nx] === 2)) canGo = true;
                    if(canGo && !bombs.find(b => b.x === nx && b.y === ny)) { e.x = nx; e.y = ny; }
                    else { let d = [[0,1],[0,-1],[1,0],[-1,0]][Math.floor(Math.random()*4)]; e.dx = d[0]; e.dy = d[1]; }
                    e.t = 0;
                }
                if(e.x === player.x && e.y === player.y) { if(player.invuln === 0) { player.hp--; player.invuln = 60; } }
            });
            drawHuman(player.x, player.y, player.color, frame, player.invuln, false, false);
            if(player.invuln > 0) player.invuln--;
            if(player.hp <= 0) location.reload();
            updateUI();
        }
        frame++; requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
